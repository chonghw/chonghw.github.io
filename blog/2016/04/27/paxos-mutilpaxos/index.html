<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Paxos/Mutil-paxos 算法浅析 - Diting0x</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="在前几篇博客中，讨论了我在伯克利最后一学期修的分布式系统编程课程中的内容。">
<meta property="og:type" content="article">
<meta property="og:title" content="Paxos/Mutil-paxos 算法浅析">
<meta property="og:url" content="http://yoursite.com/blog/2016/04/27/paxos-mutilpaxos/index.html">
<meta property="og:site_name" content="Diting0x">
<meta property="og:description" content="在前几篇博客中，讨论了我在伯克利最后一学期修的分布式系统编程课程中的内容。">
<meta property="og:updated_time" content="2016-04-30T04:27:15.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Paxos/Mutil-paxos 算法浅析">
<meta name="twitter:description" content="在前几篇博客中，讨论了我在伯克利最后一学期修的分布式系统编程课程中的内容。">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="/webfonts/ptserif/main.css" rel='stylesheet' type='text/css'>
  <link href="/webfonts/source-code-pro/main.css" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <header id="header">
  <div id="header-outer" class="outer">
    <div id="header-inner" class="inner">
      <a id="main-nav-toggle" class="nav-icon" href="javascript:;"></a>
      <a id="logo" class="logo" href="/"></a>
      <nav id="main-nav">
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/categories">Categories</a>
        
          <a class="main-nav-link" href="/tags">Tags</a>
        
          <a class="main-nav-link" href="/about">About</a>
        
          <a class="main-nav-link" href="/atom.xml">Rss</a>
        
      </nav>
      <nav id="sub-nav">
        <div id="search-form-wrap">
          <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
        </div>
      </nav>
    </div>
  </div>
</header>
    <section id="main" class="outer"><article id="post-paxos-mutilpaxos" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Paxos/Mutil-paxos 算法浅析
    </h1>
  

      </header>
    
    <div class="article-meta">
      <a href="/blog/2016/04/27/paxos-mutilpaxos/" class="article-date">
  <time datetime="2016-04-27T12:48:54.000Z" itemprop="datePublished">2016-04-27</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/Algorithm/">Algorithm</a>
  </div>

      
        <div class="article-comment-link-wrap">
          <a href="http://yoursite.com/blog/2016/04/27/paxos-mutilpaxos/#ds-thread" class="article-comment-link">Комментарии</a>
        </div>
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>在前几篇博客中，讨论了我在伯克利最后一学期修的分布式系统编程课程中的内容。</p>
<a id="more"></a> 
<p>那时我参与的项目太酷了- 我们组一步步完成了从quorum KVS到分布式锁管理，又实现了Multi-paxos算法作为我们最终提交的项目。这篇博客，我会从普通的Paxos算法说起。</p>
<p>简单来说，Paxos是将一组节点在单个值上达成一致的协议(严格来说，是指一个协议簇，这是 <a href="https://en.wikipedia.org/wiki/Paxos_\(computer_science" target="_blank" rel="external">维基百科</a> 上的说法)</p>
<h3 id="Paxos算法为什么重要？"><a href="#Paxos算法为什么重要？" class="headerlink" title="Paxos算法为什么重要？"></a>Paxos算法为什么重要？</h3><p>如果有一个固定的的master节点，master节点就可以自己决策并提案值，让其它节点跟着使用这个值就行，那Paxos算法就没有任何用武之地了。倘若决策者的选举失败（有时就会这样），这时有两个节点提案值呢？</p>
<p>Paxos算法能保证在所有提案的值中选出一个唯一的值。当你想在分布式系统中的一系列值中做决策时，或者说，在这一系列的值中决策出一致的顺序，Paxos算法就派上用场了。</p>
<pre><code>[译者注]：分布式系统中要保证日志的一致性，往往要决策哪个值才能真正被写入到各节点中的日志中以保证每个节点的日志记录的条目是相同的
</code></pre><p>像<a href="https://ayende.com/blog/4496/paxos-enlightment" target="_blank" rel="external">Ayende Rahien</a>描述的那样，如果这些值是指一些事件，那在一个集群中所有的机器都能保持相同的状态或者状态的子集。</p>
<h3 id="Paxos-算法"><a href="#Paxos-算法" class="headerlink" title="Paxos 算法"></a>Paxos 算法</h3><p>Paxos算法分两个阶段进行，准备阶段(Prepare Phase）与批准阶段（Accept Phase)。</p>
<p>声明：下面章节的一些用词部分来源于Leslie Lamport的论文： <a href="http://research.microsoft.com/en-us/um/people/lamport/pubs/paxos-%20simple.pdf" target="_blank" rel="external">Paxo Made Simple</a>.</p>
<h4 id="准备阶段"><a href="#准备阶段" class="headerlink" title="准备阶段"></a>准备阶段</h4><p>在准备阶段，提案者（proposor)选出一个提案编号 <code>n</code> (此编号比提案者之前发送出的任何一个 编号都要大，也与任何其他提案者的编号 不同，将在下面详细讨论)，然后发送一个 <code>PREPARE</code> 请求给批准者的多数派。</p>
<p>对批准者（acceptor)来说，如果收到的 <code>PREPARE</code> 请求中的提案编号 <code>n</code> 比它之前收到的任何提案编号都要大，就会响应一个“承诺”  (promise)，指出之后不会回应任何一个比这个提案编号要小的编号,以及已经收到过的最大提案编号(如果有的话).</p>
<pre><code>[译者注]:一个节点可以同时担任提案者与批准者；另外，注意这里的编号大小决定着此次提案的优先级
</code></pre><p>开始听起来有点困惑了？</p>
<p>在真正理解前我也读了好几遍，再看看下面的伪代码也许会有所帮助。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta"># Proposer</span></span><br><span class="line"><span class="keyword">for</span> acceptor in acceptors</span><br><span class="line">  send :prepare_req, next_n()</span><br><span class="line"></span><br><span class="line"><span class="meta"># Acceptor</span></span><br><span class="line"><span class="keyword">if</span> (req.n &gt; highest_proposed_n)</span><br><span class="line">  highest_proposed_n = req.n</span><br><span class="line">  reply :prepare_resp, &#123;</span><br><span class="line">    :n =&gt; highest_acc.n,</span><br><span class="line">    :value =&gt; highest_acc.value</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h4 id="批准阶段"><a href="#批准阶段" class="headerlink" title="批准阶段"></a>批准阶段</h4><p>当提案者收到批准者中多数派对 <code>PREPARE</code> 请求的响应后，给批准者发送一个含有值 <code>v</code> 的 <code>ACCEPT</code> 信号，<code>v</code> 是收到的响应中最高提案编号中的值，当响应中没有任何批准的值时，<code>v</code> 可以是任意值。</p>
<p>当批准者收到 <code>ACCEPT</code> 请求时，总会接收这个请求，除非它已经在准备阶段承诺过不再接收任何请求。</p>
<pre><code>[译者注]：注意，提案编号和提案值是不同的，类似于&lt;key,value&gt;的关系
</code></pre><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta"># Proposer</span></span><br><span class="line"><span class="keyword">for</span> acceptor in acceptors</span><br><span class="line">  send :accept_req, responses.argmax &#123; |i| i.n &#125;.value &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta"># Acceptor</span></span><br><span class="line"><span class="keyword">if</span> (req.n &gt;= highest_proposed_n)</span><br><span class="line">  highest_acc = &#123;:n =&gt; req.n, :value =&gt; req.value&#125;</span><br><span class="line">  reply :accept_resp</span><br></pre></td></tr></table></figure>
<h3 id="Mutil-Paxos-算法"><a href="#Mutil-Paxos-算法" class="headerlink" title="Mutil-Paxos 算法"></a>Mutil-Paxos 算法</h3><p>上面所讲的是 Paxos 算法。那 Multi-paxos 算法是如何工作的呢？</p>
<p>前面提到，Paxos 算法最主要的应用在于，能让许多参与者在一系列列数值中做出决策。当Paxos算法结束运行一轮后，会生成一个提案值 <code>v</code> ，要决策出一系列的提案值来，最简单的方法就是多次运行 Paxos 算法，对不对？</p>
<p>实际上这种情况可以对 Paxos 算法进行优化： 设定一个固定的决策者，可以用来跳过准备阶段。假定这种决策关系能够保持”粘性”，就没必要继续发出提案编号—第一个被发送的提案号始终不会被覆盖，因为这时只有一个决策者。</p>
<p>因此，我们只需要运行一次准备阶段就够了。在 Paxos 算法接下来的几轮中，我们只需要发送 <code>ACCEPT</code> 消息，附带一个在原始 <code>PREPARE</code> 请求中用过的提案编号 <code>n</code> ,和一个额外的参数来表示我们正在运行的轮数序列号。最坏的情况不过是决策关系不是固定的(或者说不是唯一的),这时我们也不必担心，因为算法会自动降级到普通的Paxos算法中(每一轮过程中都有准备阶段和批准阶段）。好酷！</p>
<h3 id="其它考虑"><a href="#其它考虑" class="headerlink" title="其它考虑"></a>其它考虑</h3><h4 id="永久存储"><a href="#永久存储" class="headerlink" title="永久存储"></a>永久存储</h4><p>系统必须保证一些数据能永久存储，以防能从失效中恢复。<br>尤其是，批准者需要记住它们承诺过要响应哪个 <code>PREPARE</code> 请求以及它们响应过的 <code>ACCEPT</code> 请求，这样做是为了决策出要承诺哪个提案并能传递一些必要的信息反馈给此提案。</p>
<h4 id="唯一的提案编号-n"><a href="#唯一的提案编号-n" class="headerlink" title="唯一的提案编号 n"></a>唯一的提案编号 <code>n</code></h4><p>为了能让算法正常工作，每个提案者必须递增地增加提案编号 <code>n</code>，<code>n</code> 必须不同于其它任何提案者的编号.</p>
<p>为了满足这个条件，我们为每个提案者分配一个互斥的数值集合，并让它们只能从自己的集合中选取编号（比如说，给每个节点分配一个单独的素数，它们可以选择素数的不同倍数作为一个集合）</p>
<p>或者，我们也可以设定参与者成员的静态属性，为每个节点分配一个从0到 <code>k</code> 之间的唯一数值<code>i</code>，<code>k</code> 是参与者的总数，<code>n=i+(k*轮数)</code>.</p>
<h3 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h3><p>长话短说: Paxos 算法的目标是能让集群中的机器在一个提案值上最终达到统一（或者更有用的情况是，能为一系列数值决策出一致的顺序）。Multi-paxos 算法是对连续许多轮执行 Paxos 算法的一种优化，如果你设定了一个决策者，就可以跳过其中的一个阶段。</p>
<p>希望这篇博客能对你有用。我不是这个领域的专家，所以希望能听到更多的评论与修正。</p>
<p>若有兴趣，可继续阅读<a href="http://www.chongh.wiki/blog/2016/04/28/understand-paxos1/" target="_blank" rel="external">下一篇</a></p>
<h3 id="Acknowledgement"><a href="#Acknowledgement" class="headerlink" title="Acknowledgement"></a>Acknowledgement</h3><p>注：[特别重要]</p>
<p>[Lamport论文中对Paxos算法的描述是出了名的晦涩难懂，也由于Paxos算法本身的复杂性，以至于让Lamport每次都得解释好几遍。故挑选几篇对Paxos算法描述比较浅显易懂的博客翻译，希望能对大家理解Paxos算法有那么一点点帮助</p>
<p>译者水平有限，对Paxos算法的理解离Lamport大师本人要表达的精髓还相差甚远，如有不对的地方，请一定要指出]</p>
<p>本文遵守Attribution-NonCommercial-NoDerivatives 4.0 International License (CC BY-NC-ND 4.0)</p>
<p>译文，仅为学习使用，未经博主同意，请勿转载。</p>
<p>原英文地址：<a href="http://amberonrails.com/paxosmulti-paxos-algorithm/" target="_blank" rel="external">http://amberonrails.com/paxosmulti-paxos-algorithm/</a></p>
<p>本文地址： <a href="http://www.chongh.wiki/blog/2016/04/27/paxos-mutilpaxos/" target="_blank" rel="external">http://www.chongh.wiki/blog/2016/04/27/paxos-mutilpaxos/</a></p>
<p>译者 [ 新浪微博: <a href="http://weibo.com/2767520802/profile?rightmod=1&amp;wvr=6&amp;mod=personinfo" target="_blank" rel="external">@diting0x</a>]，感谢好友<a href="http://weibo.com/u/2765244861?topnav=1&amp;wvr=6&amp;topsug=1&amp;is_all=1" target="_blank" rel="external">@睡眼惺忪的小叶先生</a>与我几次激烈的讨论，对本文很有帮助</p>

      
    </div>
    
    
      <footer class="article-footer">
        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Algorithm/">Algorithm</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Distributed/">Distributed</a></li></ul>

      </footer>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/blog/2016/04/28/understand-paxos1/" id="article-nav-newer" class="article-nav-link-wrap">
      <div class="article-nav-title"><span>&lt;</span>&nbsp;
        
          深入理解Paxos算法(一)
        
      </div>
    </a>
  
  
    <a href="/blog/2016/04/26/shikongnote1/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">新生物文明与蜂群思维&nbsp;<span>&gt;</span></div>
    </a>
  
</nav>

  
</article>




<div class="share_addthis">
  <div class="sharing addthis_toolbox share">
    <a class="addthis_button_facebook_like"></a>
    <a class="addthis_button_tweet"></a>
    <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
    <a class="addthis_counter addthis_pill_style"></a>
  </div>
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-560c64c35486b3d4" async="async"></script>
</div>






<section id="comments">
  <!-- 多说评论框 start -->
  <div class="ds-thread" data-thread-key="post-paxos-mutilpaxos" data-title="Paxos/Mutil-paxos 算法浅析" data-url="http://yoursite.com/blog/2016/04/27/paxos-mutilpaxos/"></div>
  <!-- 多说评论框 end -->
  <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
  <script type="text/javascript">
  var duoshuoQuery = {short_name:'chongh'};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0] 
       || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
    </script>
  <!-- 多说公共JS代码 end -->
</section>
</section>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 Diting0x&nbsp;
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, theme by <a href="http://github.com/ppoffice">PPOffice</a>
    </div>
  </div>
</footer>
    

<script src="/js/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>
  </div>
</body>
</html>